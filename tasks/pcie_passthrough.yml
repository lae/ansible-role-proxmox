---
- block:
    - name: Enable CPU IOMMU in default grub
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        line:
          "GRUB_CMDLINE_LINUX=\"iommu=pt\
          {% if '\"GenuineIntel\" in ansible_processor | unique' %} intel_iommu=on{% else %} amd_iommu=on{% endif %}\""
        insertafter: '^GRUB_CMDLINE_LINUX="'
      notify: update-grub

    - name: Enable Mediated Devices (gvt-g) in default grub
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        line: GRUB_CMDLINE_LINUX="i915.enable_gvt=1"
        insertafter: '^GRUB_CMDLINE_LINUX="'
      when: "pve_mediated_devices_enabled | bool"
      notify: update-grub

- name: Enable IOMMU unsafe interrupts
  ansible.builtin.copy:
    content: "options vfio_iommu_type1 allow_unsafe_interrupts=1"
    dest: /etc/modprobe.d/iommu_unsafe_interrupts.conf
    mode: 0640
  when: "pve_iommu_unsafe_interrupts | bool"

- block:
    - name: Modify modules list for PCIe Passthrough
      ansible.builtin.blockinfile:
        dest: /etc/modules
        marker: "# {mark}: Modules required for PCI passthrough (managed by ansible)."
        content: |
          vfio
          vfio_iommu_type1
          vfio_pci
          vfio_virqfd
      notify: update-initramfs

    - name: Modify modules list for GVT-g
      ansible.builtin.blockinfile:
        dest: /etc/modules
        marker: "# {mark}: Modules required for GVT-g (managed by ansible)."
        content: |
          kvmgt
      when: "pve_mediated_devices_enabled | bool"
      notify: update-initramfs
