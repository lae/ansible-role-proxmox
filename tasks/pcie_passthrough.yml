---
- block:
    - name: Enable CPU IOMMU in default grub
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: ^GRUB_CMDLINE_LINUX_DEFAULT=
        line: GRUB_CMDLINE_LINUX_DEFAULT="quiet iommu=pt{% if '"GenuineIntel" in ansible_processor | unique' %} intel_iommu=on{% else %} amd_iommu=on{% endif %}{% if pve_mediated_devices_enabled %} i915.enable_gvt=1{% endif %}"
      register: iommu_modify

    - name: Update default grub
      ansible.builtin.command: update-grub
      when: iommu_modify.changed

- name: Enable IOMMU unsafe interrupts
  ansible.builtin.copy:
    content: "options vfio_iommu_type1 allow_unsafe_interrupts=1"
    dest: /etc/modprobe.d/iommu_unsafe_interrupts.conf
    mode: 0640
  when: pve_iommu_unsafe_interrupts

- block:
    - name: Modify modules list for PCIe Passthrough
      ansible.builtin.blockinfile:
        dest: /etc/modules
        marker: "# {mark}: Modules required for PCI passthrough (managed by ansible)."
        content: |
          vfio
          vfio_iommu_type1
          vfio_pci
          vfio_virqfd
      register: modules_list_pcie

    - name: Modify modules list for GVT-g
      ansible.builtin.blockinfile:
        dest: /etc/modules
        marker: "# {mark}: Modules required for GVT-g (managed by ansible)."
        content: |
          kvmgt
      register: modules_list_gvtg
      when: pve_mediated_devices_enabled

    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u -k all
      when: modules_list_pcie.changed or modules_list_gvtg.changed
